# @package _global_

defaults:
  - colbert_qa_retriever
  - override /model: option_retriever
  - override /model/head: colbert # todo colbert
  - override /model/bert: pubmed
  - override /datamodule/builder: concat_openqa
  - override /datamodule/index_builder: colbert # todo colbert
  - override /datamodule/builder/analytics:
      - retriever_accuracy

base:
  seed: null
  target_metric: validation/reader/Accuracy
  target_mode: max

trainer:
  gpus: 8
  strategy: dp
  min_epochs: 1
  max_epochs: 1_000
  accumulate_grad_batches: 4
  val_check_interval: 0.5

model:
  module:
    resample_k: null
    alpha: 0
    max_batch_size: 128
    eval_topk: 30

datamodule:
  # how often to map the dataset
  mapping_freq: 5 # todo: debug

  # dataloader
  train_batch_size: 8
  eval_batch_size: 16 # todo: debug
  num_workers: 16 # setting this too high might lead `Dataset.map()` to hang
  persistent_workers: false
  pin_memory: true
  # drop_last: true # todo: fix this

  # dataset builder
  use_subset: false # todo: debug
  num_proc: 4
  output_columns:
    - answer.target
    - question.input_ids
    - question.attention_mask
    - document.input_ids
    - document.attention_mask
    - document.row_idx
    - document.match_score
    - document.retrieval_score

  # documents
  n_retrieved_documents: 1_000 # todo: debug
  n_documents:
    train: 10 # todo: debug
    validation: 100 # todo: debug
    test: 100 # todo: debug
  max_pos_docs: 1
  filter_unmatched: false
  select_mode: sample

  # tag documents as positive or negative
  relevance_classifier:
    interpretable: false

  # OpenQA builder parameters
  builder:
    batch_size: 100
    writer_batch_size: 1_000
    dataset_builder:
      n_query_tokens: 0
    corpus_builder:
      use_subset: false # todo: debug

  # Index parameters
  index_builder:
    model_output_keys: [ _hq_retriever_, _hd_retriever_ ]
    faiss_args:
      factory: IVF100,PQ16x8
      metric_type: 0 # =faiss.METRIC_INNER_PRODUCT
      nprobe: 32
    loader_kwargs:
      batch_size: 4_000
      num_workers: 8
      pin_memory: true

  transform:
    rate: 0

logger:
  wandb:
    group: option-retriever
