# @package _global_

defaults:
  - option_retriever
  - override /model: medqa_reader
  - override /model/module/retriever_head: none
  - override /model/module/reader_head: none
  - override /model/module/gradients: none
  - override /model/bert: pubmed_multiple_choice
  - override /datamodule/index_builder: elasticsearch
  - override /datamodule/builder/analytics: none
  - override /datamodule/transform: view_reader_stack
  - override /callbacks:
      - checkpoint
      - progress_bar
      - lr_monitor

base:
  seed: 1
  target_metric: validation/reader/Accuracy
  target_mode: max
  exp_info: "--"
  batch_size: 32
  device_batch_size: 1
  eval_device_batch_size: 24
  infer_batch_mul: 100


trainer:
  min_epochs: 1
  max_epochs: 30
  max_steps: 30000 # maybe  use fewer steps
  accumulate_grad_batches:  ${base.accumulate_grad_batches}
  val_check_interval: 1.0
  precision: 32

model:
  lr: 1e-5
  weight_decay: 1e-3
  num_lr_warmup_steps: 1_000
  num_training_steps: 100_000 # learning rate is decay from 1 to 0 during these steps

datamodule:
  builder:
    dataset_builder:
      dset_name: medqa-us
      max_length: 312
    corpus_builder:
      dset_name: medqa
  dset_name: medqa-us
  corpus_name: medqa
  dataset_update: null # don't update dataset
  num_proc: 4
  num_workers: 4
  output_columns:
    - question.input_ids
    - question.attention_mask
    - document.input_ids
    - document.attention_mask
    - document.row_idx
    - document.match_score
    - document.proposal_score
    - document.proposal_rank
    - answer.input_ids
    - answer.attention_mask
    - answer.target

  # documents
  n_documents: 3

  # document sampler
  sampler:
    total: ${datamodule.n_documents}
    largest:
      train: false
      validation: true
      test: true

  index_builder:
    es_temperature: 10. # divide the scores by a factor 10 (more uniform distribution)
    auxiliary_weight: 2. # boost the answer options by a factor (5 = 1 + 4)


logger:
  wandb:
   name: null
   group: baseline-reader-us-stack # name your experiment here
